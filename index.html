<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ™ºå‰ª Â· AIè§†é¢‘å‰ªè¾‘</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&family=JetBrains+Mono:wght@400;600&display=swap');
:root{--bg:#07070e;--s1:#10101a;--s2:#181826;--s3:#20202e;--bd:#28283c;--ac:#7c6dfa;--ac2:#f06292;--tx:#e4e4f0;--mu:#5a5a7a;--ok:#34d399;--warn:#fbbf24;--r:10px}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Noto Sans SC',sans-serif;background:var(--bg);color:var(--tx);min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;background:radial-gradient(ellipse 65% 50% at 8% 8%,rgba(124,109,250,.08) 0,transparent 55%),radial-gradient(ellipse 55% 55% at 92% 92%,rgba(240,98,146,.06) 0,transparent 55%)}
::-webkit-scrollbar{width:3px;height:3px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--bd);border-radius:2px}
header{position:sticky;top:0;z-index:300;display:flex;align-items:center;justify-content:space-between;padding:14px 28px;background:rgba(7,7,14,.92);backdrop-filter:blur(20px);border-bottom:1px solid var(--bd)}
.logo{font-family:'JetBrains Mono',monospace;font-size:18px;font-weight:600;background:linear-gradient(130deg,var(--ac),var(--ac2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.logo em{font-size:11px;color:var(--mu);font-family:'Noto Sans SC',sans-serif;-webkit-text-fill-color:var(--mu);margin-left:8px;font-style:normal}
.api-chip{display:flex;align-items:center;gap:7px;font-size:12px;color:var(--mu);cursor:pointer;padding:6px 14px;border:1px solid var(--bd);border-radius:100px;background:none;transition:.2s}
.api-chip:hover{border-color:var(--ac);color:var(--tx)}
.led{width:7px;height:7px;border-radius:50%;background:var(--mu);flex-shrink:0}
.led.on{background:var(--ok);box-shadow:0 0 7px var(--ok)}
.ov{position:fixed;inset:0;z-index:800;background:rgba(0,0,0,.82);backdrop-filter:blur(14px);display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .3s}
.ov.show{opacity:1;pointer-events:all}
.modal{background:var(--s1);border:1px solid var(--bd);border-radius:18px;padding:32px 34px;width:500px;max-width:94vw;transform:translateY(16px);transition:transform .3s}
.ov.show .modal{transform:translateY(0)}
.modal h2{font-size:18px;font-weight:700;margin-bottom:4px}
.modal-sub{font-size:12px;color:var(--mu);margin-bottom:20px;line-height:1.75}
.fld{margin-bottom:14px}
.fld label{display:block;font-size:11px;color:var(--mu);margin-bottom:5px;letter-spacing:.5px;text-transform:uppercase}
.fld input,.fld select,.fld textarea{width:100%;background:var(--s2);border:1px solid var(--bd);border-radius:var(--r);padding:10px 13px;color:var(--tx);font-size:13px;outline:none;transition:border-color .2s;font-family:inherit}
.fld input:focus,.fld select:focus,.fld textarea:focus{border-color:var(--ac)}
.fld select option{background:var(--s2)}
.fld textarea{resize:vertical;min-height:80px;line-height:1.7;font-size:13px}
.pw-row{position:relative}
.pw-row input{padding-right:40px;font-family:'JetBrains Mono',monospace;font-size:12px}
.eye{position:absolute;right:11px;top:50%;transform:translateY(-50%);cursor:pointer;font-size:13px;user-select:none}
.ibox{background:var(--s2);border-radius:var(--r);padding:11px 13px;font-size:11px;color:var(--mu);line-height:1.85;margin-bottom:18px}
.ibox code{background:var(--s3);padding:1px 5px;border-radius:4px;font-family:'JetBrains Mono',monospace;color:var(--ac);font-size:10px}
.ibox strong{color:var(--tx)}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:9px 18px;border-radius:var(--r);border:none;cursor:pointer;font-size:13px;font-weight:500;font-family:'Noto Sans SC',sans-serif;transition:.18s;white-space:nowrap}
.btn-p{background:linear-gradient(135deg,var(--ac),#a78bfa);color:#fff}
.btn-p:hover:not(:disabled){opacity:.87;transform:translateY(-1px);box-shadow:0 5px 18px rgba(124,109,250,.4)}
.btn-ok{background:linear-gradient(135deg,var(--ok),#22d3ee);color:#000;font-weight:700}
.btn-ok:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 5px 18px rgba(52,211,153,.4)}
.btn-g{background:var(--s2);color:var(--tx);border:1px solid var(--bd)}
.btn-g:hover:not(:disabled){border-color:var(--ac);color:var(--ac)}
.btn-d{background:rgba(240,98,146,.1);color:var(--ac2);border:1px solid rgba(240,98,146,.22)}
.btn-d:hover:not(:disabled){background:rgba(240,98,146,.2)}
.btn-sm{padding:4px 10px;font-size:11px;border-radius:7px}
.btn-fw{width:100%}
.btn:disabled{opacity:.3;cursor:not-allowed;transform:none!important;box-shadow:none!important}
.wrap{position:relative;z-index:1;max-width:1360px;margin:0 auto;padding:20px}
.grid{display:grid;grid-template-columns:1fr 380px;gap:18px;align-items:start}
.dropzone{border:2px dashed var(--bd);border-radius:16px;padding:50px 24px;text-align:center;cursor:pointer;transition:.25s;background:var(--s1);position:relative;overflow:hidden}
.dropzone::after{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(124,109,250,.05),rgba(240,98,146,.04));opacity:0;transition:.25s}
.dropzone:hover,.dropzone.drag{border-color:var(--ac)}
.dropzone:hover::after,.dropzone.drag::after{opacity:1}
.dz-icon{font-size:40px;display:block;margin-bottom:12px}
.dropzone h3{font-size:16px;margin-bottom:5px}
.dropzone p{font-size:13px;color:var(--mu)}
.dropzone .fmts{font-size:10px;color:var(--mu);margin-top:11px;font-family:'JetBrains Mono',monospace}
.vcard{background:var(--s1);border:1px solid var(--bd);border-radius:16px;overflow:hidden}
.vscreen{background:#000;aspect-ratio:16/9;position:relative}
.vscreen video{width:100%;height:100%;object-fit:contain;display:block}
.tl{padding:10px 14px;border-top:1px solid var(--bd)}
.tl-lbl{font-size:10px;color:var(--mu);font-family:'JetBrains Mono',monospace;margin-bottom:5px}
.tl-track{height:28px;background:var(--s2);border-radius:5px;position:relative;overflow:hidden;cursor:pointer}
.tl-seg{position:absolute;top:0;height:100%;border-left:1px solid;border-right:1px solid;transition:background .18s}
.tl-seg.keep{background:rgba(124,109,250,.18);border-color:rgba(124,109,250,.5)}
.tl-seg.keep.sel{background:rgba(124,109,250,.45);border-color:var(--ac)}
.tl-seg.cut{background:rgba(240,98,146,.1);border-color:rgba(240,98,146,.4)}
.tl-needle{position:absolute;top:0;width:2px;height:100%;background:var(--warn);z-index:5;pointer-events:none;transition:left .1s linear}
.steps{display:flex;padding:11px 14px;border-bottom:1px solid var(--bd)}
.step{flex:1;text-align:center;font-size:10px;color:var(--mu);position:relative}
.step:not(:last-child)::after{content:'';position:absolute;top:8px;left:54%;right:-46%;height:1px;background:var(--bd)}
.step.done:not(:last-child)::after,.step.active:not(:last-child)::after{background:var(--ac)}
.sdot{width:17px;height:17px;border-radius:50%;background:var(--bd);display:flex;align-items:center;justify-content:center;margin:0 auto 4px;font-size:8px;font-weight:700;transition:.3s}
.step.active .sdot{background:var(--ac);box-shadow:0 0 9px rgba(124,109,250,.6)}
.step.done .sdot{background:var(--ok)}
.pbar{height:3px;background:var(--bd);margin:0 14px;border-radius:2px;overflow:hidden;display:none}
.pbar.on{display:block}
.pfill{height:100%;width:0;background:linear-gradient(90deg,var(--ac),var(--ac2));transition:width .2s}
.ptxt{font-size:11px;color:var(--mu);padding:5px 14px 0;min-height:20px}
.logbox{font-family:'JetBrains Mono',monospace;font-size:10px;padding:2px 14px 8px;line-height:1.95;max-height:88px;overflow-y:auto;color:var(--mu);display:none}
.logbox.on{display:block}
.linfo{color:var(--mu)}.lok{color:var(--ok)}.lerr{color:var(--ac2)}.lapi{color:var(--ac)}.lwarn{color:var(--warn)}
.vinfo{padding:11px 14px;border-bottom:1px solid var(--bd);display:flex;justify-content:space-between;align-items:center}
.vname{font-size:13px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:260px}
.vmeta{font-size:10px;color:var(--mu);font-family:'JetBrains Mono',monospace;margin-top:2px}
.abar{padding:11px 14px;display:flex;gap:8px;flex-wrap:wrap;border-top:1px solid var(--bd)}
.dlarea{padding:11px 14px;border-top:1px solid var(--bd)}
.panel{background:var(--s1);border:1px solid var(--bd);border-radius:16px;display:flex;flex-direction:column;position:sticky;top:72px;max-height:calc(100vh - 92px)}
.ph{padding:12px 14px;border-bottom:1px solid var(--bd);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.ptitle{font-size:14px;font-weight:600}
.pbadge{font-size:10px;color:var(--mu);background:var(--s2);padding:2px 8px;border-radius:100px}
.slist{overflow-y:auto;flex:1;padding:8px}
.sitem{border:1px solid var(--bd);border-radius:8px;padding:9px 11px;margin-bottom:5px;cursor:pointer;transition:.18s}
.sitem:hover{border-color:rgba(124,109,250,.4);background:rgba(124,109,250,.04)}
.sitem.sel{border-color:var(--ac);background:rgba(124,109,250,.1)}
.sitem.del{opacity:.2;pointer-events:none;text-decoration:line-through}
.stime{font-size:10px;font-family:'JetBrains Mono',monospace;color:var(--ac);margin-bottom:3px;display:flex;gap:6px;align-items:center}
.cut-tag{font-size:9px;color:var(--ac2);background:rgba(240,98,146,.1);padding:1px 5px;border-radius:3px;border:1px solid rgba(240,98,146,.2)}
.stxt{font-size:12px;line-height:1.55}
.sact{display:flex;gap:4px;margin-top:7px}
.empty-state{text-align:center;padding:30px 12px;color:var(--mu);font-size:12px;line-height:1.8}
.empty-icon{font-size:26px;display:block;margin-bottom:8px}
.selarea{border-top:1px solid var(--bd);padding:10px 10px 4px;flex-shrink:0}
.selhead{font-size:11px;color:var(--mu);margin-bottom:8px;display:flex;align-items:center;justify-content:space-between}
.seglist{display:flex;flex-direction:column;gap:5px;max-height:172px;overflow-y:auto;margin-bottom:4px}
.segcard{background:var(--s2);border:1px solid var(--bd);border-radius:7px;padding:8px 10px;display:flex;align-items:flex-start;gap:7px;transition:border-color .18s;cursor:pointer}
.segcard:hover{border-color:rgba(124,109,250,.35)}
.segcard.playing{border-color:var(--ac);background:rgba(124,109,250,.08)}
.segnum{font-size:10px;font-family:'JetBrains Mono',monospace;color:var(--ac);min-width:22px;padding-top:1px;flex-shrink:0}
.segbody{flex:1;min-width:0}
.segtime{font-size:10px;color:var(--mu);font-family:'JetBrains Mono',monospace;margin-bottom:2px}
.segtxt{font-size:11px;line-height:1.5;word-break:break-all}
.segact{display:flex;gap:3px;flex-shrink:0}
.genbtn{margin:10px;padding:12px;font-size:13px;font-weight:700;border-radius:var(--r)}
.toast{position:fixed;bottom:20px;right:20px;z-index:9999;background:var(--s1);border:1px solid var(--bd);border-radius:var(--r);padding:11px 16px;font-size:12px;max-width:320px;line-height:1.5;transform:translateY(60px);opacity:0;transition:.26s}
.toast.show{transform:translateY(0);opacity:1}
.toast.ok{border-color:var(--ok)}.toast.err{border-color:var(--ac2)}.toast.warn{border-color:var(--warn)}
.spin{width:13px;height:13px;border:2px solid rgba(255,255,255,.2);border-top-color:#fff;border-radius:50%;animation:rot .7s linear infinite;display:inline-block;flex-shrink:0}
@keyframes rot{to{transform:rotate(360deg)}}
.hidden{display:none!important}
.analyze-modal .modal{text-align:center;padding:40px}
.analyze-modal .u-icon{font-size:40px;margin-bottom:14px}
.analyze-modal .u-title{font-size:16px;font-weight:600;margin-bottom:6px}
.analyze-modal .u-sub{font-size:12px;color:var(--mu);margin-bottom:20px;line-height:1.6}
.u-prog{height:4px;background:var(--bd);border-radius:2px;overflow:hidden;margin-bottom:8px}
.u-pfill{height:100%;background:linear-gradient(90deg,var(--ac),var(--ac2));transition:width .3s}
.u-ptxt{font-size:11px;color:var(--mu);font-family:'JetBrains Mono',monospace}
.api-note{background:rgba(124,109,250,.07);border:1px solid rgba(124,109,250,.2);border-radius:8px;padding:10px 13px;font-size:11px;color:var(--mu);line-height:1.85;margin-bottom:16px}
.api-note strong{color:var(--ac)}
@media(max-width:840px){.grid{grid-template-columns:1fr}.panel{position:static;max-height:none}}
</style>
</head>
<body>

<!-- API Config Modal -->
<div class="ov show" id="apiModal">
  <div class="modal">
    <h2>ğŸ”‘ é…ç½® Anthropic API</h2>
    <p class="modal-sub">è¾“å…¥ Anthropic API Keyï¼Œå°†ä½¿ç”¨ Claude Vision å¯¹è§†é¢‘å¸§è¿›è¡ŒçœŸå®è¯­ä¹‰åˆ†æï¼Œç”Ÿæˆå¸¦æ—¶é—´æˆ³å­—å¹•ã€‚</p>
    <div class="fld">
      <label>ANTHROPIC API KEY</label>
      <div class="pw-row">
        <input type="password" id="keyInp" placeholder="ç²˜è´´ Anthropic API Key (sk-ant-...)" autocomplete="off" />
        <span class="eye" id="eyeBtn" onclick="toggleEye()">ğŸ‘</span>
      </div>
    </div>
    <div class="fld">
      <label>åˆ†æå¯†åº¦ <span style="font-size:10px;color:var(--mu);text-transform:none">ï¼ˆæ¯å‡ ç§’æˆªå–ä¸€å¸§ï¼Œè¶Šå¯†è¶Šå‡†ç¡®ä½†è¶Šæ…¢ï¼‰</span></label>
      <select id="fpsInp">
        <option value="3">æ¯3ç§’1å¸§ï¼ˆå¿«é€Ÿï¼Œé€‚åˆé•¿è§†é¢‘ï¼‰</option>
        <option value="2">æ¯2ç§’1å¸§ï¼ˆå‡è¡¡ï¼‰</option>
        <option value="1" selected>æ¯1ç§’1å¸§ï¼ˆæ¨èï¼‰</option>
      </select>
    </div>
    <div class="api-note">
      ğŸš€ <strong>å·¥ä½œåŸç†ï¼š</strong>æå–è§†é¢‘å¸§ â†’ Claude Vision åˆ†æ â†’ ç”Ÿæˆæ—¶é—´æˆ³å­—å¹•<br>
      ğŸ”’ <strong>å®‰å…¨ï¼š</strong>API Key ä»…å­˜äºæœ¬åœ°æµè§ˆå™¨<br>
      ğŸ“Œ è·å– Keyï¼š<strong>console.anthropic.com</strong> â†’ API Keys<br>
      âš ï¸ <strong>CORS è¯´æ˜ï¼š</strong>è‹¥æç¤º"Failed to fetch"ï¼Œè¯·å®‰è£…æµè§ˆå™¨æ‰©å±•<br>
      &nbsp;&nbsp;&nbsp;Chromeï¼šæœç´¢ <strong>"Allow CORS"</strong> æˆ– <strong>"CORS Unblock"</strong> æ‰©å±•å¹¶å¼€å¯
    </div>
    <button class="btn btn-p btn-fw" onclick="saveConfig()">ä¿å­˜å¹¶å¼€å§‹ä½¿ç”¨</button>
  </div>
</div>

<!-- Analyze Progress Modal -->
<div class="ov analyze-modal" id="analyzeModal">
  <div class="modal">
    <div class="u-icon">ğŸ¤–</div>
    <div class="u-title">Claude Vision æ­£åœ¨åˆ†æ...</div>
    <div class="u-sub">æ­£åœ¨æå–è§†é¢‘å¸§å¹¶è¿›è¡Œ AI è¯­ä¹‰åˆ†æ<br>è¯·å‹¿å…³é—­é¡µé¢</div>
    <div class="u-prog"><div class="u-pfill" id="anaPfill" style="width:0%"></div></div>
    <div class="u-ptxt" id="anaPtxt">å‡†å¤‡ä¸­...</div>
  </div>
</div>

<!-- Edit Subtitle Modal -->
<div class="ov" id="editModal">
  <div class="modal" style="max-width:540px">
    <h2>âœï¸ ç¼–è¾‘å­—å¹•ç‰‡æ®µ</h2>
    <p class="modal-sub">ç›´æ¥ä¿®æ”¹æ–‡å­—å†…å®¹ï¼›åˆ å‡æ–‡å­—åè§†é¢‘æ—¶é•¿æŒ‰æ¯”ä¾‹ç¼©çŸ­ï¼›æ¸…ç©ºåˆ™åˆ é™¤æ•´æ®µã€‚</p>
    <div class="fld">
      <label>æ—¶é—´èŒƒå›´</label>
      <input type="text" id="editTime" readonly style="color:var(--ac);font-family:'JetBrains Mono',monospace;font-size:12px" />
    </div>
    <div class="fld">
      <label>å­—å¹•å†…å®¹</label>
      <textarea id="editTxt" rows="4" placeholder="ç¼–è¾‘å­—å¹•æ–‡å­—..."></textarea>
    </div>
    <div style="display:flex;gap:9px;margin-top:4px">
      <button class="btn btn-p" style="flex:1" onclick="saveEdit()">ä¿å­˜ä¿®æ”¹</button>
      <button class="btn btn-g" style="flex:.45" onclick="closeEdit()">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<header>
  <div><span class="logo">æ™ºå‰ª<em>AIè§†é¢‘å‰ªè¾‘</em></span></div>
  <button class="api-chip" onclick="openApiModal()">
    <span class="led" id="led"></span>
    <span id="apiTxt">é…ç½® API Key</span>
  </button>
</header>

<div class="wrap">
  <div class="grid">
    <div>
      <div class="dropzone" id="dropzone" onclick="pickFile()">
        <span class="dz-icon">ğŸ¬</span>
        <h3>æ‹–æ‹½è§†é¢‘åˆ°æ­¤å¤„ä¸Šä¼ </h3>
        <p>æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
        <div class="fmts">MP4 Â· MOV Â· AVI Â· MKV Â· WebM</div>
        <input type="file" id="fileInp" accept="video/*" style="display:none" onchange="onFilePick(event)" />
      </div>

      <div class="vcard hidden" id="vcard">
        <div class="vscreen"><video id="vp" controls></video></div>
        <div class="tl hidden" id="tl">
          <div class="tl-lbl">æ—¶é—´è½´ â€” è“è‰²=å·²é€‰ ç²‰è‰²=AIå»ºè®®åˆ é™¤ é»„çº¿=å½“å‰æ’­æ”¾ä½ç½®</div>
          <div class="tl-track" id="tlTrack" onclick="tlSeek(event)">
            <div class="tl-needle" id="tlNeedle"></div>
          </div>
        </div>
        <div class="vinfo">
          <div>
            <div class="vname" id="vname">â€”</div>
            <div class="vmeta" id="vmeta">â€”</div>
          </div>
          <button class="btn btn-g btn-sm" onclick="resetAll()">é‡æ–°ä¸Šä¼ </button>
        </div>
        <div class="steps">
          <div class="step active" id="s1"><div class="sdot">1</div>ä¸Šä¼ </div>
          <div class="step" id="s2"><div class="sdot">2</div>æå–å¸§</div>
          <div class="step" id="s3"><div class="sdot">3</div>AIåˆ†æ</div>
          <div class="step" id="s4"><div class="sdot">4</div>å­—å¹•ç”Ÿæˆ</div>
          <div class="step" id="s5"><div class="sdot">5</div>å¯¼å‡º</div>
        </div>
        <div class="pbar" id="pbar"><div class="pfill" id="pfill"></div></div>
        <div class="ptxt" id="ptxt"></div>
        <div class="logbox" id="logbox"></div>
        <div class="abar">
          <button class="btn btn-p" id="anaBtn" onclick="startPipeline()">ğŸ¤– AI åˆ†æè§†é¢‘</button>
          <button class="btn btn-g hidden" id="reBtn" onclick="startPipeline()">ğŸ”„ é‡æ–°åˆ†æ</button>
        </div>
        <div class="dlarea hidden" id="dlarea">
          <button class="btn btn-ok btn-fw" id="genVideoBtn" onclick="generateVideo()" style="padding:12px;font-size:14px;margin-bottom:8px">
            âœ¨ åˆæˆæœ€ç»ˆè§†é¢‘ï¼ˆåµŒå…¥å­—å¹•ï¼‰
          </button>
          <button class="btn btn-g btn-fw" onclick="downloadResult()" id="dlBtn" disabled style="padding:11px;font-size:13px">
            â¬‡ï¸ ä¸‹è½½å‰ªè¾‘æˆç‰‡ (.webm)
          </button>
          <p style="font-size:11px;color:var(--mu);margin-top:6px;text-align:center">å­—å¹•åµŒå…¥ç”»é¢ Â· WebM æ ¼å¼</p>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="ph">
        <span class="ptitle">å­—å¹•ç‰‡æ®µ</span>
        <span class="pbadge" id="pbadge">0 ä¸ª</span>
      </div>
      <div class="slist" id="slist">
        <div class="empty-state">
          <span class="empty-icon">ğŸ™ï¸</span>
          ä¸Šä¼ è§†é¢‘åç‚¹å‡»<br>ã€ŒAI åˆ†æè§†é¢‘ã€<br>
          <span style="font-size:10px;color:var(--mu);margin-top:6px;display:block">Claude Vision å°†åˆ†æè§†é¢‘å¸§å¹¶ç”Ÿæˆå­—å¹•</span>
        </div>
      </div>
      <div class="selarea">
        <div class="selhead">
          <span>âœ… å·²é€‰ç‰‡æ®µ</span>
          <span style="font-size:10px" id="selDur">â€”</span>
        </div>
        <div class="seglist" id="seglist">
          <div style="font-size:11px;color:var(--mu);text-align:center;padding:8px">å°šæœªé€‰æ‹©ä»»ä½•ç‰‡æ®µ</div>
        </div>
      </div>
      <button class="btn btn-p btn-fw genbtn" id="genBtn" disabled onclick="openDlArea()">âœ¨ ç”Ÿæˆè§†é¢‘</button>
    </div>
  </div>
</div>

<script>
'use strict';
let cfg=null,vFile=null,vURL=null,vDur=0,subs=[],editId=null,outBlob=null;

window.addEventListener('DOMContentLoaded',()=>{
  const saved=localStorage.getItem('zhijian_cfg_v1');
  if(saved){try{cfg=JSON.parse(saved);applyCfg();document.getElementById('apiModal').classList.remove('show');}catch(e){}}
  const dz=document.getElementById('dropzone');
  dz.addEventListener('dragover',e=>{e.preventDefault();dz.classList.add('drag');});
  dz.addEventListener('dragleave',()=>dz.classList.remove('drag'));
  dz.addEventListener('drop',e=>{e.preventDefault();dz.classList.remove('drag');const f=e.dataTransfer.files[0];if(f&&f.type.startsWith('video/'))loadVideo(f);else toast('è¯·ä¸Šä¼ è§†é¢‘æ–‡ä»¶','err');});
  document.getElementById('vp').addEventListener('timeupdate',()=>{if(!vDur)return;document.getElementById('tlNeedle').style.left=(document.getElementById('vp').currentTime/vDur*100)+'%';});
  document.getElementById('editModal').addEventListener('click',e=>{if(e.target.id==='editModal')closeEdit();});
});

function toggleEye(){const i=document.getElementById('keyInp'),b=document.getElementById('eyeBtn');i.type=i.type==='password'?'text':'password';b.textContent=i.type==='password'?'ğŸ‘':'ğŸ™ˆ';}
function openApiModal(){if(cfg){document.getElementById('keyInp').value=cfg.apiKey;document.getElementById('fpsInp').value=cfg.frameInterval||'1';}document.getElementById('apiModal').classList.add('show');}
function saveConfig(){
  const k=document.getElementById('keyInp').value.trim();
  const fi=document.getElementById('fpsInp').value;
  if(!k){toast('è¯·å¡«å†™ API Key','err');return;}
  // Accept any non-empty key (format may vary)
  cfg={apiKey:k,frameInterval:parseFloat(fi)};
  localStorage.setItem('zhijian_cfg_v1',JSON.stringify(cfg));
  applyCfg();document.getElementById('apiModal').classList.remove('show');toast('âœ“ API Key å·²ä¿å­˜','ok');
}
function applyCfg(){document.getElementById('led').classList.add('on');document.getElementById('apiTxt').textContent=cfg.apiKey.slice(0,10)+'****';}

function pickFile(){document.getElementById('fileInp').click();}
function onFilePick(e){const f=e.target.files[0];if(f)loadVideo(f);}
function loadVideo(file){
  if(!cfg){toast('è¯·å…ˆé…ç½® API Key','err');openApiModal();return;}
  if(vURL)URL.revokeObjectURL(vURL);
  vFile=file;vURL=URL.createObjectURL(file);
  const vp=document.getElementById('vp');
  vp.src=vURL;
  vp.onloadedmetadata=()=>{
    vDur=vp.duration;
    document.getElementById('vname').textContent=file.name;
    document.getElementById('vmeta').textContent=`æ—¶é•¿: ${fmt(vDur)} Â· å¤§å°: ${(file.size/1048576).toFixed(1)} MB Â· ${file.type||'video'}`;
  };
  document.getElementById('dropzone').classList.add('hidden');
  document.getElementById('vcard').classList.remove('hidden');
  subs=[];outBlob=null;renderSubList();renderSegList();resetSteps();setP(0,'');showProg(false);
  document.getElementById('genBtn').disabled=true;
  document.getElementById('dlarea').classList.add('hidden');
  document.getElementById('tl').classList.add('hidden');
  document.getElementById('logbox').innerHTML='';document.getElementById('logbox').classList.remove('on');
  document.getElementById('anaBtn').classList.remove('hidden');
  document.getElementById('reBtn').classList.add('hidden');
}

async function startPipeline(){
  if(!cfg){toast('è¯·å…ˆé…ç½® API Key','err');return;}
  if(!vFile){toast('è¯·å…ˆä¸Šä¼ è§†é¢‘','err');return;}
  if(vDur<=0){toast('è§†é¢‘åŠ è½½ä¸­ï¼Œè¯·ç¨å','warn');return;}
  const anaBtn=document.getElementById('anaBtn');
  anaBtn.disabled=true;anaBtn.innerHTML='<div class="spin"></div> åˆ†æä¸­...';
  document.getElementById('reBtn').classList.add('hidden');
  document.getElementById('logbox').classList.add('on');
  document.getElementById('dlarea').classList.add('hidden');
  subs=[];outBlob=null;renderSubList();renderSegList();
  document.getElementById('genBtn').disabled=true;
  try{
    setStep(1);showProg(true);
    log('<span class="linfo">ğŸï¸ ä»è§†é¢‘ä¸­æå–å…³é”®å¸§...</span>');
    setP(5,'æå–è§†é¢‘å¸§...');
    const frames=await extractFrames(vFile,cfg.frameInterval||1);
    log(`<span class="lok">âœ“ æå–äº† ${frames.length} å¸§</span>`);
    setP(30,`å·²æå– ${frames.length} å¸§ï¼Œå‘é€ç»™ AI...`);
    setStep(2);
    log(`<span class="lapi">â†’ å‘é€è‡³ Claude Vision è¿›è¡Œè¯­ä¹‰åˆ†æ...</span>`);
    document.getElementById('analyzeModal').classList.add('show');
    setStep(3);
    const rawJson=await analyzeFramesWithClaude(frames);
    document.getElementById('analyzeModal').classList.remove('show');
    log('<span class="lok">âœ“ Claude åˆ†æå®Œæˆï¼Œè§£æå­—å¹•æ•°æ®...</span>');
    setP(85,'è§£æå­—å¹•ç»“æ„...');
    setStep(4);
    subs=parseSubtitles(rawJson);
    if(!subs.length)throw new Error('å­—å¹•è§£æç»“æœä¸ºç©ºï¼Œè¯·é‡è¯•');
    log(`<span class="lok">âœ“ è§£æå‡º ${subs.length} ä¸ªå­—å¹•ç‰‡æ®µ</span>`);
    setP(100,'å®Œæˆï¼');setStep(5);
    renderSubList();renderTimeline();renderSegList();
    document.getElementById('tl').classList.remove('hidden');
    anaBtn.classList.add('hidden');
    document.getElementById('reBtn').classList.remove('hidden');
    toast(`âœ… åˆ†æå®Œæˆï¼${subs.length} ä¸ªå­—å¹•ç‰‡æ®µ`,'ok');
  }catch(err){
    document.getElementById('analyzeModal').classList.remove('show');
    log(`<span class="lerr">âŒ ${err.message}</span>`);
    toast('å¤±è´¥ï¼š'+err.message,'err');
    anaBtn.disabled=false;anaBtn.innerHTML='ğŸ¤– AI åˆ†æè§†é¢‘';
  }finally{showProg(false);}
}

async function extractFrames(file,intervalSec=1){
  return new Promise((resolve,reject)=>{
    const video=document.createElement('video');
    video.muted=true;video.preload='auto';
    const url=URL.createObjectURL(file);
    video.src=url;
    video.onloadedmetadata=async()=>{
      const duration=video.duration;
      const canvas=document.createElement('canvas');
      const ctx=canvas.getContext('2d');
      const maxFrames=40;
      const totalExpected=Math.floor(duration/intervalSec);
      const actualInterval=totalExpected>maxFrames?duration/maxFrames:intervalSec;
      const frameCount=Math.min(maxFrames,Math.floor(duration/actualInterval)+1);
      canvas.width=Math.min(video.videoWidth||640,640);
      canvas.height=Math.min(video.videoHeight||360,360);
      if(totalExpected>maxFrames)log(`<span class="lwarn">âš  å¸§æ•°è¿‡å¤šï¼Œè‡ªåŠ¨è°ƒæ•´ä¸ºæ¯ ${actualInterval.toFixed(1)}s ä¸€å¸§ï¼ˆå…±${frameCount}å¸§ï¼‰</span>`);
      const frames=[];
      for(let i=0;i<frameCount;i++){
        const t=Math.min(i*actualInterval,duration-0.1);
        video.currentTime=t;
        await new Promise(r=>{video.onseeked=r;});
        ctx.drawImage(video,0,0,canvas.width,canvas.height);
        const dataUrl=canvas.toDataURL('image/jpeg',0.75);
        frames.push({time:t,base64:dataUrl.split(',')[1]});
        const pct=Math.round((i+1)/frameCount*100);
        document.getElementById('anaPfill').style.width=(pct*0.3)+'%';
        document.getElementById('anaPtxt').textContent=`æå–å¸§ ${i+1}/${frameCount}...`;
        setP(5+pct*0.25,`æå–å¸§ ${i+1}/${frameCount}...`);
        await sleep(10);
      }
      URL.revokeObjectURL(url);resolve(frames);
    };
    video.onerror=()=>{URL.revokeObjectURL(url);reject(new Error('è§†é¢‘åŠ è½½å¤±è´¥'));};
  });
}

async function analyzeFramesWithClaude(frames){
  document.getElementById('anaPfill').style.width='35%';
  document.getElementById('anaPtxt').textContent='æ„å»º API è¯·æ±‚...';
  const msgContent=[];
  msgContent.push({type:'text',text:`ä½ æ˜¯ä¸“ä¸šçš„è§†é¢‘å­—å¹•ç”Ÿæˆå’Œå†…å®¹å‰ªè¾‘ä¸“å®¶ã€‚æˆ‘æä¾›äº†ä¸€æ®µè§†é¢‘çš„ ${frames.length} å¸§æˆªå›¾ï¼Œæ¯å¸§æ ‡æ³¨äº†æ—¶é—´æˆ³ã€‚è¯·åˆ†æï¼š
1. è¯†åˆ«ç”»é¢ä¸­çš„æ–‡å­—ï¼ˆå­—å¹•/æ ‡é¢˜/è¯´æ˜ï¼‰
2. æ ¹æ®ç”»é¢ä¸Šä¸‹æ–‡æ¨æ–­è¯­éŸ³å†…å®¹æˆ–å¯¹è¯
3. å°†è§†é¢‘åˆ’åˆ†ä¸ºæœ‰æ„ä¹‰çš„æ—¶é—´æ®µï¼ˆæ¯æ®µ2-8ç§’ï¼‰
4. æ ‡è¯†å†—ä½™ç‰‡æ®µï¼ˆé»‘å±/é™æ­¢/é‡å¤å†…å®¹ï¼‰ï¼Œå»ºè®®åˆ é™¤

è§†é¢‘æ€»æ—¶é•¿ï¼š${vDur.toFixed(1)} ç§’

ä»¥ä¸¥æ ¼JSONæ ¼å¼è¾“å‡ºï¼ˆä¸å«å…¶ä»–æ–‡å­—ï¼‰ï¼š
{"segments":[{"start":0.0,"end":3.5,"text":"ç”»é¢æˆ–è¯­éŸ³å†…å®¹","keep":true,"reason":"åŸå› "}],"summary":"æ¦‚è¿°"}

è¦æ±‚ï¼š
- start/end å•ä½ç§’ï¼Œç²¾ç¡®åˆ°å°æ•°ç‚¹å1ä½
- æ‰€æœ‰ç‰‡æ®µè¿ç»­è¦†ç›– 0 åˆ° ${vDur.toFixed(1)} ç§’
- textï¼šæœ‰å­—å¹•åˆ™è½¬å½•ï¼Œæœ‰è¯­éŸ³åˆ™æè¿°å†…å®¹ï¼Œæ— åˆ™æè¿°ç”»é¢
- keep=false è¡¨ç¤ºå»ºè®®åˆ é™¤ï¼ˆé»‘å±/é™æ­¢/é‡å¤ï¼‰`});
  frames.forEach((f,i)=>{
    msgContent.push({type:'text',text:`[å¸§ ${i+1}/${frames.length} | æ—¶é—´: ${f.time.toFixed(1)}s]`});
    msgContent.push({type:'image',source:{type:'base64',media_type:'image/jpeg',data:f.base64}});
  });
  document.getElementById('anaPfill').style.width='50%';
  document.getElementById('anaPtxt').textContent='å‘é€è‡³ Claude Visionï¼Œç­‰å¾…å“åº”...';
  log(`<span class="lapi">â†’ è°ƒç”¨ Claude Vision API  frames=${frames.length}</span>`);

  // Try multiple CORS strategies
  const tryFetch = async (url, options) => {
    // Strategy 1: direct with special header
    try {
      const r = await fetch(url, {...options, headers:{...options.headers,'anthropic-dangerous-direct-browser-access':'true'}});
      return r;
    } catch(e1) {
      log(`<span class="lwarn">  ç›´è¿å¤±è´¥(${e1.message})ï¼Œå°è¯•ä»£ç†...</span>`);
    }
    // Strategy 2: corsproxy.io
    try {
      const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(url);
      const r = await fetch(proxyUrl, options);
      return r;
    } catch(e2) {
      log(`<span class="lwarn">  ä»£ç†1å¤±è´¥(${e2.message})ï¼Œå°è¯•å¤‡ç”¨ä»£ç†...</span>`);
    }
    // Strategy 3: allorigins
    try {
      const proxyUrl2 = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url);
      const r = await fetch(proxyUrl2, options);
      return r;
    } catch(e3) {
      throw new Error('æ‰€æœ‰è¿æ¥æ–¹å¼å‡å¤±è´¥ã€‚è¯·æ£€æŸ¥ï¼š\n1. API Key æ˜¯å¦æ­£ç¡®\n2. ç½‘ç»œæ˜¯å¦æ­£å¸¸\n3. å°è¯•ä½¿ç”¨æ”¯æŒ CORS çš„æµè§ˆå™¨æ‰©å±•ï¼ˆå¦‚ Allow CORSï¼‰');
    }
  };

  const reqBody = JSON.stringify({
    model:'claude-opus-4-6',
    max_tokens:8192,
    temperature:0.2,
    messages:[{role:'user',content:msgContent}]
  });

  const response = await tryFetch('https://api.anthropic.com/v1/messages', {
    method:'POST',
    headers:{
      'Content-Type':'application/json',
      'x-api-key':cfg.apiKey,
      'anthropic-version':'2023-06-01'
    },
    body: reqBody
  });

  document.getElementById('anaPfill').style.width='90%';
  document.getElementById('anaPtxt').textContent='å¤„ç†å“åº”...';
  if(!response.ok){
    let msg=`API è¯·æ±‚å¤±è´¥ HTTP ${response.status}`;
    try{const j=await response.json();if(j?.error?.message)msg+=': '+j.error.message;else msg+=': '+JSON.stringify(j).slice(0,200);}catch(e){}
    throw new Error(msg);
  }
  const data=await response.json();
  const tok=data.usage;
  log(`<span class="lapi">â† å“åº” OK  tokens: in=${tok?.input_tokens||'?'} out=${tok?.output_tokens||'?'}</span>`);
  const out=data.content?.[0]?.text;
  if(!out)throw new Error('æ¨¡å‹è¿”å›å†…å®¹ä¸ºç©º');
  return out;
}

function parseSubtitles(raw){
  let s=raw.trim().replace(/^```json\s*/i,'').replace(/^```\s*/i,'').replace(/```\s*$/g,'').trim();
  const a=s.indexOf('{'),b=s.lastIndexOf('}');
  if(a!==-1&&b!==-1)s=s.slice(a,b+1);
  let p;
  try{p=JSON.parse(s);}catch(e){throw new Error('JSONè§£æå¤±è´¥ï¼š'+e.message+'\nå‰200å­—ï¼š'+s.slice(0,200));}
  if(!p.segments||!Array.isArray(p.segments))throw new Error('è¿”å›æ•°æ®ç¼ºå°‘ segments å­—æ®µ');
  if(p.summary)log(`<span class="lwarn">ğŸ“‹ ${p.summary}</span>`);
  return p.segments.map((x,i)=>({
    id:'seg'+i,start:Math.max(0,parseFloat(x.start)||0),end:Math.min(vDur,parseFloat(x.end)||0),
    text:(x.text||`ç‰‡æ®µ${i+1}`).trim(),originalText:(x.text||`ç‰‡æ®µ${i+1}`).trim(),
    keep:x.keep!==false,reason:x.reason||'',selected:x.keep!==false,deleted:false
  })).filter(x=>x.end>x.start&&x.text);
}

function renderSubList(){
  const el=document.getElementById('slist');
  const cnt=subs.filter(s=>!s.deleted).length;
  document.getElementById('pbadge').textContent=cnt+' ä¸ª';
  if(!subs.length){el.innerHTML='<div class="empty-state"><span class="empty-icon">ğŸ™ï¸</span>ä¸Šä¼ è§†é¢‘åç‚¹å‡»<br>ã€ŒAI åˆ†æè§†é¢‘ã€</div>';return;}
  el.innerHTML=subs.map(s=>`<div class="sitem ${s.selected&&!s.deleted?'sel':''} ${s.deleted?'del':''}" onclick="toggleSub('${s.id}')">
    <div class="stime"><span>${fmt(s.start)} â†’ ${fmt(s.end)}</span>${!s.keep?'<span class="cut-tag">âœ‚ å»ºè®®åˆ é™¤</span>':''}</div>
    <div class="stxt">${esc(s.text)}</div>
    ${!s.deleted?`<div class="sact" onclick="event.stopPropagation()"><button class="btn btn-g btn-sm" onclick="editSub('${s.id}')">âœï¸ ç¼–è¾‘</button><button class="btn btn-d btn-sm" onclick="delSub('${s.id}')">ğŸ—‘ åˆ é™¤</button></div>`:''}
  </div>`).join('');
}

function renderSegList(){
  const el=document.getElementById('seglist');
  const sel=subs.filter(s=>s.selected&&!s.deleted).sort((a,b)=>a.start-b.start);
  const dur=sel.reduce((t,s)=>t+(s.end-s.start),0);
  document.getElementById('selDur').textContent=sel.length?`å…± ${fmt(dur)} / ${sel.length} æ®µ`:'â€”';
  if(!sel.length){el.innerHTML='<div style="font-size:11px;color:var(--mu);text-align:center;padding:8px">å°šæœªé€‰æ‹©ä»»ä½•ç‰‡æ®µ</div>';document.getElementById('genBtn').disabled=true;return;}
  el.innerHTML=sel.map((s,i)=>`<div class="segcard" id="sc_${s.id}" onclick="previewSeg('${s.id}')">
    <div class="segnum">#${String(i+1).padStart(2,'0')}</div>
    <div class="segbody"><div class="segtime">${fmt(s.start)} â†’ ${fmt(s.end)}</div><div class="segtxt">${esc(s.text)}</div></div>
    <div class="segact" onclick="event.stopPropagation()"><button class="btn btn-g btn-sm" onclick="editSub('${s.id}')">âœï¸</button><button class="btn btn-d btn-sm" onclick="toggleSub('${s.id}')">âœ•</button></div>
  </div>`).join('');
  document.getElementById('genBtn').disabled=false;
}

function renderTimeline(){
  if(!vDur)return;
  const track=document.getElementById('tlTrack');
  [...track.querySelectorAll('.tl-seg')].forEach(e=>e.remove());
  const needle=document.getElementById('tlNeedle');
  subs.forEach(s=>{
    const d=document.createElement('div');
    const isSel=s.selected&&!s.deleted;
    d.className='tl-seg '+(!s.keep?'cut':'keep')+(isSel&&s.keep?' sel':'');
    d.style.left=(s.start/vDur*100)+'%';d.style.width=((s.end-s.start)/vDur*100)+'%';
    d.title=`${fmt(s.start)}-${fmt(s.end)}: ${s.text}`;
    track.insertBefore(d,needle);
  });
}

function toggleSub(id){const s=subs.find(x=>x.id===id);if(!s||s.deleted)return;s.selected=!s.selected;document.getElementById('vp').currentTime=s.start;renderSubList();renderSegList();renderTimeline();}
function delSub(id){const s=subs.find(x=>x.id===id);if(s){s.deleted=true;s.selected=false;}renderSubList();renderSegList();renderTimeline();toast('ç‰‡æ®µå·²åˆ é™¤','ok');}
function previewSeg(id){
  const s=subs.find(x=>x.id===id);if(!s)return;
  const vp=document.getElementById('vp');vp.currentTime=s.start;vp.play();
  document.querySelectorAll('.segcard').forEach(c=>c.classList.remove('playing'));
  const card=document.getElementById('sc_'+id);if(card)card.classList.add('playing');
  const stopAt=s.end;
  const check=()=>{if(vp.currentTime>=stopAt){vp.pause();vp.removeEventListener('timeupdate',check);if(card)card.classList.remove('playing');}};
  vp.addEventListener('timeupdate',check);
}
function editSub(id){const s=subs.find(x=>x.id===id);if(!s)return;editId=id;document.getElementById('editTime').value=`${fmt(s.start)} â†’ ${fmt(s.end)}`;document.getElementById('editTxt').value=s.text;document.getElementById('editModal').classList.add('show');}
function saveEdit(){
  const s=subs.find(x=>x.id===editId);if(!s)return;
  const t=document.getElementById('editTxt').value.trim();
  if(!t){s.deleted=true;s.selected=false;toast('å†…å®¹ä¸ºç©ºï¼Œç‰‡æ®µå·²åˆ é™¤','ok');}
  else{const ratio=Math.min(t.length/(s.originalText.length||1),1);s.end=s.start+(s.end-s.start)*ratio;s.text=t;toast('å­—å¹•å·²æ›´æ–°','ok');}
  closeEdit();renderSubList();renderSegList();renderTimeline();
}
function closeEdit(){document.getElementById('editModal').classList.remove('show');editId=null;}
function tlSeek(e){const r=document.getElementById('tlTrack').getBoundingClientRect();document.getElementById('vp').currentTime=((e.clientX-r.left)/r.width)*vDur;}
function openDlArea(){const segs=subs.filter(s=>s.selected&&!s.deleted);if(!segs.length){toast('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªç‰‡æ®µ','err');return;}document.getElementById('dlarea').classList.remove('hidden');document.getElementById('dlarea').scrollIntoView({behavior:'smooth'});}

async function generateVideo(){
  const segs=subs.filter(s=>s.selected&&!s.deleted).sort((a,b)=>a.start-b.start);
  if(!segs.length){toast('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªç‰‡æ®µ','err');return;}
  const btn=document.getElementById('genVideoBtn');
  btn.disabled=true;btn.innerHTML='<div class="spin"></div> åˆæˆä¸­...';
  document.getElementById('dlBtn').disabled=true;showProg(true);
  try{
    log('<span class="linfo">ğŸ¬ å¼€å§‹åˆæˆè§†é¢‘...</span>');
    outBlob=await composeVideo(segs);
    setP(100,'åˆæˆå®Œæˆï¼');
    log(`<span class="lok">âœ“ åˆæˆå®Œæˆ ${segs.length}ä¸ªç‰‡æ®µ ${(outBlob.size/1048576).toFixed(2)}MB</span>`);
    document.getElementById('dlBtn').disabled=false;
    toast('ğŸ‰ åˆæˆæˆåŠŸï¼ç‚¹å‡»ä¸‹è½½ä¿å­˜ã€‚','ok');
  }catch(err){
    log(`<span class="lerr">âŒ åˆæˆå¤±è´¥: ${err.message}</span>`);
    toast('åˆæˆå¤±è´¥ï¼š'+err.message,'err');
  }finally{btn.disabled=false;btn.innerHTML='âœ¨ é‡æ–°ç”Ÿæˆ';showProg(false);}
}

async function composeVideo(segs){
  const src=document.createElement('video');src.src=vURL;src.muted=true;src.preload='auto';
  await new Promise((res,rej)=>{src.onloadeddata=res;src.onerror=()=>rej(new Error('è§†é¢‘æºåŠ è½½å¤±è´¥'));src.load();});
  const W=src.videoWidth||1280,H=src.videoHeight||720;
  const canvas=document.createElement('canvas');canvas.width=W;canvas.height=H;
  const ctx=canvas.getContext('2d');
  let stream;
  try{
    const audioCtx=new AudioContext();
    const audioSrc=audioCtx.createMediaElementSource(src);
    const dest=audioCtx.createMediaStreamDestination();
    audioSrc.connect(dest);audioSrc.connect(audioCtx.destination);
    const vs=canvas.captureStream(25);
    stream=new MediaStream([...vs.getVideoTracks(),...dest.stream.getAudioTracks()]);
    log('<span class="linfo">  éŸ³é¢‘æµï¼šAudioContext æ··æµå·²å¯ç”¨</span>');
  }catch(e){stream=canvas.captureStream(25);log('<span class="lwarn">  éŸ³é¢‘æµï¼šä¸å¯ç”¨ï¼Œè¾“å‡ºæ— å£°è§†é¢‘</span>');}
  const mime=['video/webm;codecs=vp9,opus','video/webm;codecs=vp8,opus','video/webm'].find(m=>MediaRecorder.isTypeSupported(m))||'video/webm';
  const rec=new MediaRecorder(stream,{mimeType:mime,videoBitsPerSecond:5000000});
  const chunks=[];rec.ondataavailable=e=>{if(e.data.size>0)chunks.push(e.data);};rec.start(80);
  const totalDur=segs.reduce((t,s)=>t+(s.end-s.start),0);let done=0;
  for(let i=0;i<segs.length;i++){
    const seg=segs[i];const sd=seg.end-seg.start;
    log(`<span class="linfo">  åˆæˆ #${i+1}: ${fmt(seg.start)}â†’${fmt(seg.end)}</span>`);
    await renderSeg(src,ctx,seg,W,H,fp=>setP(Math.round((done+fp*sd)/totalDur*93),`åˆæˆ ${i+1}/${segs.length}...`));
    done+=sd;
  }
  rec.stop();await new Promise(r=>{rec.onstop=r;});
  return new Blob(chunks,{type:'video/webm'});
}

async function renderSeg(src,ctx,seg,W,H,onProg){
  const FPS=25,frames=Math.ceil((seg.end-seg.start)*FPS);
  src.currentTime=seg.start;await new Promise(r=>{src.onseeked=r;});
  for(let fi=0;fi<frames;fi++){
    const t=seg.start+fi/FPS;
    if(Math.abs(src.currentTime-t)>0.12){src.currentTime=t;await new Promise(r=>{src.onseeked=r;});}
    ctx.drawImage(src,0,0,W,H);drawSub(ctx,seg.text,W,H);
    await sleep(1000/FPS);onProg(fi/frames);
  }
}

function drawSub(ctx,text,W,H){
  if(!text)return;
  const fs=Math.round(W*0.034),lh=fs*1.52,maxW=W*0.84;
  ctx.save();ctx.font=`bold ${fs}px "Noto Sans SC","Microsoft YaHei",Arial,sans-serif`;
  ctx.textAlign='center';ctx.textBaseline='alphabetic';
  const lines=[];let cur='';
  for(const ch of text){if(ctx.measureText(cur+ch).width>maxW){lines.push(cur);cur=ch;}else cur+=ch;}
  if(cur)lines.push(cur);
  const bh=lines.length*lh+20,by=H-52-bh,bw=maxW+30;
  ctx.fillStyle='rgba(0,0,0,0.65)';rrect(ctx,W/2-bw/2,by,bw,bh,8);ctx.fill();
  ctx.fillStyle='#fff';ctx.shadowColor='rgba(0,0,0,.9)';ctx.shadowBlur=4;
  lines.forEach((l,i)=>ctx.fillText(l,W/2,by+18+i*lh+fs));ctx.restore();
}

function rrect(ctx,x,y,w,h,r){
  ctx.beginPath();ctx.moveTo(x+r,y);ctx.lineTo(x+w-r,y);ctx.quadraticCurveTo(x+w,y,x+w,y+r);
  ctx.lineTo(x+w,y+h-r);ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
  ctx.lineTo(x+r,y+h);ctx.quadraticCurveTo(x,y+h,x,y+h-r);
  ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y);ctx.closePath();
}

function downloadResult(){
  if(!outBlob){toast('è¯·å…ˆç”Ÿæˆè§†é¢‘','err');return;}
  const a=document.createElement('a');a.href=URL.createObjectURL(outBlob);
  a.download='æ™ºå‰ª_'+(vFile?.name.replace(/\.[^.]+$/,'')||'output')+'.webm';a.click();toast('å¼€å§‹ä¸‹è½½â€¦','ok');
}

function resetAll(){
  if(vURL)URL.revokeObjectURL(vURL);
  vFile=null;vURL=null;vDur=0;subs=[];outBlob=null;
  document.getElementById('dropzone').classList.remove('hidden');
  document.getElementById('vcard').classList.add('hidden');
  document.getElementById('fileInp').value='';
  const ab=document.getElementById('anaBtn');ab.disabled=false;ab.innerHTML='ğŸ¤– AI åˆ†æè§†é¢‘';ab.classList.remove('hidden');
  document.getElementById('reBtn').classList.add('hidden');document.getElementById('genBtn').disabled=true;
  document.getElementById('dlarea').classList.add('hidden');document.getElementById('tl').classList.add('hidden');
  document.getElementById('logbox').innerHTML='';document.getElementById('logbox').classList.remove('on');
  setP(0,'');showProg(false);renderSubList();renderSegList();resetSteps();
}

function resetSteps(){for(let i=1;i<=5;i++){const e=document.getElementById('s'+i);e.className='step'+(i===1?' active':'');}}
function setStep(n){for(let i=1;i<=5;i++){const e=document.getElementById('s'+i);e.className='step'+(i<n?' done':i===n?' active':'');}}
function showProg(v){document.getElementById('pbar').className='pbar'+(v?' on':'');}
function setP(v,t){document.getElementById('pfill').style.width=v+'%';if(t!==undefined)document.getElementById('ptxt').textContent=t;}
function log(html){const e=document.getElementById('logbox');e.innerHTML+=html+'\n';e.scrollTop=e.scrollHeight;}
function fmt(s){if(isNaN(s)||s==null)return'0:00';return Math.floor(s/60)+':'+String(Math.floor(s%60)).padStart(2,'0');}
function sleep(ms){return new Promise(r=>setTimeout(r,ms));}
function esc(s){return(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
let toastT;
function toast(msg,type=''){const e=document.getElementById('toast');e.textContent=msg;e.className='toast show'+(type?' '+type:'');clearTimeout(toastT);toastT=setTimeout(()=>e.classList.remove('show'),5000);}
</script>
</body>
</html>